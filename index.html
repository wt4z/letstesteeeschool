<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Bullis School ‚Äì Potomac</title>
<style>
:root{
  --gold:#FFC726;
  --notif-bg:rgba(44,44,44,0.92);
}
body{font-family:Arial,sans-serif;margin:0;background:#f4f7fb;color:#08304a}
header{background:#002F6C;color:var(--gold);padding:20px;text-align:center}
nav{background:#e2e8f0;padding:10px;display:flex;justify-content:center;gap:20px}
nav a{text-decoration:none;color:#002F6C;font-weight:bold}
main{padding:20px;max-width:900px;margin:auto}
section{background:#fff;padding:15px;margin-bottom:15px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
h2{color:#002F6C}
footer{background:#002F6C;color:var(--gold);text-align:center;padding:15px}
img.logo{height:50px;vertical-align:middle;margin-right:10px}
#hotspot{position:fixed;bottom:10px;right:10px;width:40px;height:40px;background:transparent;cursor:pointer;z-index:1200}
#passwordBox{position:fixed;bottom:60px;right:10px;display:none;z-index:1201;background:#fff;border:2px solid #002F6C;border-radius:8px;padding:10px;box-shadow:0 2px 6px rgba(0,0,0,.15);width:320px}
#passwordBox input{display:block;margin-bottom:6px;padding:8px;font-size:14px;border:1px solid #ccc;border-radius:4px;width:100%;box-sizing:border-box}
#passwordBox button{padding:8px;font-size:14px;background:#002F6C;color:var(--gold);border:none;border-radius:4px;cursor:pointer;width:100%}
#errorText{color:#c0392b;font-size:13px;margin-top:6px;display:none}
#embedContainer{display:none;margin-top:20px;width:100%;height:500px}
#adminPanel{display:none;padding:12px;background:#fff;border-radius:8px;border:2px solid #002F6C;box-shadow:0 2px 6px rgba(0,0,0,.12);margin-top:20px}
.acct{display:flex;align-items:center;justify-content:space-between;border:1px solid #e6eef9;padding:8px;border-radius:6px;margin-bottom:8px;background:#f8fbff}
.acct .meta{font-size:14px;color:#08304a}
.revealBtn{background:#002F6C;color:var(--gold);border:none;padding:6px 8px;border-radius:6px;cursor:pointer}
.small{font-size:13px;color:#485b6b}
.badge{display:inline-block;padding:2px 6px;font-size:11px;font-weight:bold;border-radius:4px;margin-left:6px;color:#fff}
.badge.owner{background:#d6336c}
.badge.admin{background:#0052cc}
.badge.contributor{background:#22863a}
.badge.forever{background:#ffb800;color:#000}
.badge.supporter{background:#FFFF00;color:#394361}
.badge.üè¶{background:#FFFF00;color:#394361}
#announcementsSection{display:none;}
#cmdOverlay{position:fixed;left:50%;transform:translateX(-50%);bottom:22%;width:88%;max-width:900px;z-index:1300;display:none;justify-content:center;align-items:center;pointer-events:auto}
#cmdPanel{width:100%;border-radius:12px;padding:14px 16px;box-shadow:0 12px 30px rgba(0,0,0,0.4);border:1px solid rgba(255,199,38,0.25);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));backdrop-filter: blur(8px);display:flex;gap:12px;align-items:center}
#cmdInput{flex:1;background:rgba(255,255,255,0.03);border:none;outline:none;color:var(--gold);padding:10px 12px;border-radius:8px;font-size:15px;box-shadow:inset 0 0 0 1px rgba(255,255,255,0.02)}
#cmdSubmit{background:transparent;border:1px solid rgba(255,199,38,0.18);color:var(--gold);padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:bold}
#cmdHint{color:#ddd;font-size:13px;margin-left:8px}
#notifArea{position:fixed;left:18px;bottom:18px;z-index:1400;display:flex;flex-direction:column-reverse;gap:10px;max-width:360px}
.notif{background:var(--notif-bg);color:#fff;padding:12px 14px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,0.45);border:1px solid rgba(255,199,38,0.12);display:flex;gap:10px;align-items:flex-start;min-width:220px;position:relative;overflow:hidden}
.notif strong{color:var(--gold)}
.notif .closeBtn{position:absolute;right:8px;top:6px;background:transparent;border:none;color:#fff;font-weight:bold;cursor:pointer;font-size:14px}
#clearAllBtn{display:none;align-self:flex-start;padding:6px 10px;border-radius:8px;border:1px solid rgba(255,199,38,0.18);background:transparent;color:var(--gold);cursor:pointer;margin-bottom:6px}
.notif .meta{font-size:12px;color:#e8e8e8;margin-top:6px}
</style>
</head>
<body>

<header>
  <img src="https://resources.finalsite.net/images/f_auto,q_auto,t_image_size_1/v1721670094/bullis/vbqhybisnzf52q6lwhbd/SecondaryBulldogFullColor.png" alt="Bulldog Logo" class="logo">
  <span>Bullis School ‚Äì Potomac, MD</span>
  <p>‚ÄúCaring ‚Ä¢ Challenging ‚Ä¢ Community‚Äù</p>
</header>

<nav>
  <a href="#">Home</a>
  <a href="#">About</a>
  <a href="#">Students</a>
  <a href="#">Faculty & Staff</a>
  <a href="#">Contact</a>
</nav>

<main>
  <section id="announcementsSection">
    <h2>Announcements</h2>
    <ul id="announcementsList"><li>Loading announcements...</li></ul>
  </section>

  <section>
    <h2>Upcoming Events</h2>
    <ul>
      <li>Varsity Football: Saturday at 1 p.m. at Kline Stadium</li>
      <li>Upper School Science Expo: Next Tuesday, 5‚Äì7 p.m.</li>
      <li>Drama Production: ‚ÄúThe Taming of the Shrew‚Äù ‚Äì Thursday, 7 p.m.</li>
    </ul>
  </section>

  <section>
    <h2>Resources</h2>
    <p>Access your schedules, class links, and our Bulldog community portal. Stay connected, stay inspired.</p>
  </section>

  <div id="adminPanel" aria-hidden="true"></div>
  <div id="embedContainer"><iframe src="https://myappsclasslink.pegle.com" width="100%" height="100%" style="border:0"></iframe></div>
</main>

<div id="hotspot" title="secret"></div>
<div id="passwordBox"></div>

<div id="cmdOverlay" aria-hidden="true">
  <div id="cmdPanel" role="dialog" aria-label="Admin command bar">
    <input id="cmdInput" placeholder="Type command (help ‚Üí list commands)" autocomplete="off">
    <button id="cmdSubmit">Run</button>
    <div id="cmdHint" aria-hidden="true">Press ' to open/close</div>
  </div>
</div>

<div id="notifArea" aria-live="polite" aria-atomic="false">
  <button id="clearAllBtn">Clear All</button>
</div>

<footer>
  &copy; 2025 Bullis School ‚Ä¢ 10601 Falls Rd, Potomac, MD 20854
</footer>

<script>
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQKXYi7qzpIctH1NwhbKyrP8jyl06p85XMQJxNci8fZvzabyLNo0aChyfRNX2-WOlWdF4qT0LnCD37X/pub?output=csv";
let validUsers = [], currentUser = null;
const NOTIF_TIMEOUT_MS = 30000;

async function loadUsersFromSheet() {
  try {
    const res = await fetch(SHEET_CSV+"?cachebust="+Date.now());
    const text = await res.text();
    const lines = text.trim().split("\n");
    const headers = lines[0].split(",");
    validUsers = lines.slice(1).map(line=>{
      const cols = line.split(",");
      let user={};
      headers.forEach((h,i)=>user[h.trim()] = (cols[i]||"").trim());
      user.isAdmin = user.isAdmin==="true";
      return user;
    });
    if(currentUser) createNotification("Users Updated","CSV refreshed");
  } catch(e){ console.error("Load users error:",e); }
}

// Auto-refresh every minute
loadUsersFromSheet();
setInterval(loadUsersFromSheet,60000);

function createNotification(title,message,options={}) {
  const notif = document.createElement("div");
  notif.className="notif";
  notif.innerHTML=`<div><strong>${title}</strong><div class="meta">${message}</div></div>`;
  const closeBtn = document.createElement("button");
  closeBtn.className="closeBtn"; closeBtn.innerHTML="‚úï";
  closeBtn.addEventListener("click",()=>{ notif.remove(); updateClearBtn(); });
  notif.appendChild(closeBtn);
  document.getElementById("notifArea").appendChild(notif);
  updateClearBtn();
  if(!options.sticky) setTimeout(()=>{ notif.remove(); updateClearBtn(); },options.timeoutMs||NOTIF_TIMEOUT_MS);
}

function updateClearBtn(){ 
  document.getElementById("clearAllBtn").style.display = 
    document.querySelectorAll("#notifArea .notif").length>1?"inline-block":"none";
}
document.getElementById("clearAllBtn").addEventListener("click",()=>{
  document.querySelectorAll("#notifArea .notif").forEach(n=>n.remove()); updateClearBtn();
});

async function onLoginClick() {
  await loadUsersFromSheet();
  const userInput=document.getElementById('loginUser').value.trim();
  const passInput=document.getElementById('loginPass').value.trim();
  const account = validUsers.find(u=>u.username===userInput);
  if(!account || account.password!==passInput){ alert("Invalid username or password"); return; }
  const now = new Date();
  if(account.expires.toLowerCase()!=="never" && new Date(account.expires)<now){
    alert("Account expired on "+account.expires); return;
  }
  currentUser = account;
  document.getElementById('announcementsSection').style.display='block';
  loadAnnouncements(10);
  if(account.isAdmin) showAdminPanel();
  document.getElementById('passwordBox').style.display='none';
}

document.getElementById('hotspot').addEventListener('click',()=>{
  const pw = document.getElementById('passwordBox');
  pw.innerHTML = `
    <input id="loginUser" type="text" placeholder="Username" autocomplete="username">
    <input id="loginPass" type="password" placeholder="Password" autocomplete="current-password">
    <button id="loginBtn">‚Üí</button>
    <div id="errorText"></div>`;
  pw.style.display='block';
  document.getElementById('loginUser').focus();
  document.getElementById('loginBtn').addEventListener('click', onLoginClick);
});

async function loadAnnouncements(limitLastN=null){
  const list = document.getElementById("announcementsList");
  try{
    const res = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vQ_-w-DAPezbAzU8xZOylF9OnrPxen42KrzJ6MayaRzHxCcj8i6TjVDGfkqidkb2ouMxnit-ocEay61/pub?output=csv");
    const text = await res.text();
    const lines = text.trim().split("\n");
    if(lines.length<=1){ list.innerHTML="<li>No announcements</li>"; return; }
    const rows = lines.slice(1);
    if(limitLastN) rows.splice(0, rows.length-limitLastN);
    list.innerHTML="";
    rows.forEach(r=>{
      const cols = r.split(",");
      const li = document.createElement("li");
      li.innerHTML=`<strong>${cols[0].trim()}</strong>: ${cols[1]?.trim()||""}`;
      list.appendChild(li);
    });
  }catch(e){ list.innerHTML="<li>Failed to load announcements</li>"; console.error(e); }
}

// Admin Panel
function showAdminPanel(){
  const panel = document.getElementById("adminPanel");
  panel.innerHTML=''; panel.style.display='block'; panel.setAttribute('aria-hidden','false');
  const title=document.createElement('div');
  title.innerHTML='<h3 style="margin:0 0 8px;color:#002F6C">Admin Console ‚Äî Accounts Database</h3>';
  panel.appendChild(title);
  validUsers.forEach(acc=>{
    const el=document.createElement('div'); el.className='acct';
    let human = acc.expires==="never"?"Never expires":(new Date(acc.expires)-Date.now()>0?Math.floor((new Date(acc.expires)-Date.now())/(1000*60*60))+" hours left":"expired");
    const meta=document.createElement('div'); meta.className='meta';
    const badgeHTML=acc.role?`<span class="badge ${acc.role.toLowerCase()}">${acc.role}</span>`:'';
    meta.innerHTML=`<strong>${acc.username}</strong> ${badgeHTML} <div class="small">${human}</div>`;
    const btn=document.createElement('button'); btn.className='revealBtn'; btn.textContent='View';
    btn.addEventListener('click',()=>{
      const existing=el.querySelector('.revealBox'); if(existing){existing.remove(); return;}
      const box=document.createElement('div'); box.className='revealBox';
      box.style.marginTop='8px'; box.style.padding='8px'; box.style.background='#fff'; box.style.border='1px solid #dde9fb'; box.style.borderRadius='6px';
      box.innerHTML=`<div style="font-size:13px;color:#08304a">Username: <strong>${acc.username}</strong></div>
        <div style="font-size:13px;color:#08304a;margin-top:6px">Password: <strong>${acc.password}</strong></div>
        <div style="font-size:12px;color:#485b6b;margin-top:6px">Expires: ${acc.expires}</div>
        <div style="font-size:12px;color:#485b6b;margin-top:6px">Role: ${acc.role||"none"}</div>
        <div style="font-size:12px;color:#485b6b;margin-top:6px">Notes: ${acc.notes||"none"}</div>`;
      el.appendChild(box);
    });
    el.appendChild(meta); el.appendChild(btn); panel.appendChild(el);
  });
}

// Command bar
const cmdOverlay = document.getElementById("cmdOverlay");
const cmdInput = document.getElementById("cmdInput");
const cmdSubmit = document.getElementById("cmdSubmit");

function toggleCmdBar(forceState){
  if(!currentUser || !currentUser.isAdmin){ createNotification("Access Denied","Admins only"); return; }
  const isShown = cmdOverlay.style.display==="flex";
  const show = typeof forceState==="boolean"?forceState:!isShown;
  cmdOverlay.style.display=show?"flex":"none"; cmdOverlay.setAttribute("aria-hidden",!show);
  if(show){ cmdInput.focus(); cmdInput.select(); }
}

async function runCommand(raw){
  const line=raw.trim(); if(!line) return;
  const parts=line.split(/\s+/), cmd=parts[0].toLowerCase(), args=parts.slice(1);
  switch(cmd){
    case "help": createNotification("Commands","help ‚Ä¢ gitstats ‚Ä¢ viewinfo [username] ‚Ä¢ reload ‚Ä¢ clear"); break;
    case "gitstats":
      createNotification("GitHub","Fetching repository stats...");
      try{
        const r = await fetch("https://api.github.com/repos/hm9m/letstesteeeschool");
        const j = await r.json();
        createNotification("GitHub Stats",`‚≠ê ${j.stargazers_count||0} ‚Ä¢ üç¥ ${j.forks_count||0} ‚Ä¢ üêõ ${j.open_issues_count||0} ‚Ä¢ updated: ${new Date(j.updated_at).toLocaleString()}`);
      }catch(e){ createNotification("GitHub Error",String(e),{sticky:false}); }
      break;
    case "viewinfo":
      if(args.length<1){ createNotification("Usage","viewinfo [username]"); break; }
      const uname=args[0];
      const acct
