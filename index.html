<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bullis School – Potomac</title>
  <style>
    /* === Your existing styles (copied & extended) === */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f4f7fb;
    }
    header {
      background-color: #002F6C; /* Bullis navy blue */
      color: #FFC726;           /* Bullis gold */
      padding: 20px;
      text-align: center;
    }
    nav {
      background-color: #e2e8f0;
      padding: 10px;
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    nav a {
      text-decoration: none;
      color: #002F6C;
      font-weight: bold;
    }
    main {
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    section {
      background-color: #ffffff;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    h2 { color: #002F6C; }

    #hotspot {
      position: fixed;
      bottom: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      background: transparent;
      cursor: pointer;
      z-index: 1000;
    }
    /* password / login box */
    #passwordBox, #loginBox {
      position: fixed;
      bottom: 60px;
      right: 10px;
      display: none;
      z-index: 1001;
      background: rgba(255,255,255,0.98);
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      width: 260px;
    }
    #passwordBox input, #loginBox input, #loginBox button {
      padding: 8px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
      margin-top: 6px;
    }
    #embedContainer {
      display: none;
      margin-top: 20px;
      width: 100%;
      height: 500px;
    }
    footer {
      background-color: #002F6C;
      color: #FFC726;
      text-align: center;
      padding: 15px;
    }
    img.logo {
      height: 50px;
      vertical-align: middle;
      margin-right: 10px;
    }

    /* BAN PAGE (client-side replacement) */
    #banWrap {
      font-family: Arial, sans-serif;
      display:flex;
      min-height:100vh;
      align-items:center;
      justify-content:center;
      background:#0d1220;
      color:#ffffff;
      margin:0;
      padding:32px;
    }
    #banCard {
      max-width:720px;
      background:#091028;
      padding:28px;
      border-radius:10px;
      box-shadow:0 8px 30px rgba(0,0,0,0.6);
      text-align:center;
    }
    #banCard h1 { color: #ffb86b; margin:0 0 8px; }
    #banCard p { color:#dbe7ff; margin:0 0 16px; }
    #banCard small { color:#9fb0d6; display:block; margin-top:8px; }
    #banCard button {
      margin-top:18px;
      padding:10px 16px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:600;
    }
  </style>
</head>
<body>

<header>
  <!-- Bulldog logo -->
  <img src="https://resources.finalsite.net/images/f_auto,q_auto,t_image_size_1/v1721670094/bullis/vbqhybisnzf52q6lwhbd/SecondaryBulldogFullColor.png" 
       alt="Bullis Bulldog Logo" class="logo">
  <span>Bullis School – Potomac, MD</span>
  <p>“Caring • Challenging • Community”</p>
</header>

<nav>
  <a href="#">Home</a>
  <a href="#">About</a>
  <a href="#">Students</a>
  <a href="#">Faculty & Staff</a>
  <a href="#">Contact</a>
</nav>

<main>
  <section>
    <h2>Announcements</h2>
    <ul>
      <li>Welcome back Week begins Monday at 8 a.m.</li>
      <li>Bulldog Spirit Day next Friday – wear blue & gold!</li>
      <li>Library opens extended hours during finals week.</li>
    </ul>
  </section>

  <section>
    <h2>Upcoming Events</h2>
    <ul>
      <li>Varsity Football: Saturday at 1 p.m. at Kline Stadium</li>
      <li>Upper School Science Expo: Next Tuesday, 5–7 p.m.</li>
      <li>Drama Production: “The Taming of the Shrew” – Thursday, 7 p.m.</li>
    </ul>
  </section>

  <section>
    <h2>Resources</h2>
    <p>Access your schedules, class links, and our Bulldog community portal. Stay connected, stay inspired.</p>
  </section>

  <!-- Hidden embed -->
  <div id="embedContainer">
    <iframe id="embedFrame" src="https://myappsclasslink.pegle.com" width="100%" height="100%"></iframe>
  </div>
</main>

<!-- Invisible hotspot (your existing secret button) -->
<div id="hotspot" title="secret"></div>

<!-- Hidden simple password box (kept for backwards compatibility) -->
<div id="passwordBox">
  <input type="password" id="password" placeholder="Developed by hm9m" />
  <button id="passwordSubmit">→</button>
</div>

<!-- New username/password login box (shown on hotspot click) -->
<div id="loginBox" aria-hidden="true">
  <label style="font-weight:bold;">Staff Login</label>
  <input id="loginUser" placeholder="Username" type="text" autocomplete="username" />
  <input id="loginPass" placeholder="Password" type="password" autocomplete="current-password" />
  <button id="loginSubmit">Sign in</button>
  <div id="loginMsg" style="margin-top:8px;font-size:13px;color:#c33;display:none;"></div>
</div>

<footer>
  &copy; 2025 Bullis School • 10601 Falls Rd, Potomac, MD 20854
</footer>

<script>
/* ================= CONFIGURATION - CHANGE THESE ================= */

/* 1) Banned IPs - client-side UX ban (exact IP strings)
   - NOTE: client-side bans can be bypassed. For reliable blocking, use server/CND controls.
   - Replace or add IPv4 strings here as needed.
*/
const CLIENT_BANNED_IPS = [
  "203.0.113.5",
  "198.51.100.42"
];

/* 2) Credentials with expiration (client-side)
   - Each entry: username, password, expires (ISO string).
   - Example: expires: "2025-12-31T23:59:59Z"
   - WARNING: These live in client code (not secure). Use server auth for production.
*/
const validCredentials = [
  { username: "staff1", password: "letmein", expires: "2025-12-31T23:59:59Z" },
  { username: "teacher", password: "bulldog2025", expires: "2026-01-01T00:00:00Z" }
];

/* 3) Google Apps Script webhook URL to log FAILED login attempts.
   - After you create & deploy the Apps Script (instructions below), paste its URL here.
   - Example: "https://script.google.com/macros/s/AKfycbxxx/exec"
*/
const FAILED_LOGIN_WEBHOOK = "CHANGE_THIS_TO_YOUR_APPS_SCRIPT_URL";

/* 4) IP lookup service (to get client IP). ipify is used (returns {"ip":"x.x.x.x"}).
   - If you run into rate limits, use another provider or host your own.
*/
const IP_LOOKUP = "https://api.ipify.org?format=json";

/* ================= END CONFIGURATION ================= */

let clientIP = null;
let clientLookupData = null;

/* Utility: set text message in login box */
function showLoginMsg(msg, isError = true) {
  const el = document.getElementById('loginMsg');
  el.style.display = 'block';
  el.style.color = isError ? '#c33' : '#2a7a2a';
  el.textContent = msg;
}

/* Render a client-side ban page (full-body replacement) */
function renderBanPage(details) {
  const html = `
    <div id="banWrap">
      <div id="banCard" role="alert" aria-live="polite">
        <h1>Access Restricted</h1>
        <p>Your device or network has been restricted from accessing this site.</p>
        <p><strong>Reference:</strong> ${details.ip || "unknown"}</p>
        <small>If you believe this is an error, contact site support at <a href="mailto:admin@bullis.edu">admin@bullis.edu</a>.</small>
        <div>
          <button onclick="location.href = 'https://www.bullis.org';">Go to Bullis Homepage</button>
        </div>
      </div>
    </div>
  `;
  document.documentElement.innerHTML = html;
  // stop further resource loads in some browsers
  try { window.stop(); } catch(e){/*ignore*/ }
}

/* Get client IP via IP_LOOKUP, then run ban-check */
async function fetchClientIP() {
  try {
    const resp = await fetch(IP_LOOKUP, { cache: "no-store" });
    clientLookupData = await resp.json();
    clientIP = clientLookupData.ip || clientLookupData.ip_address || null;

    // If no IP, do not block
    if (!clientIP) return;

    // exact match ban
    if (CLIENT_BANNED_IPS.includes(clientIP)) {
      renderBanPage({ ip: clientIP });
    }
  } catch (err) {
    // silent fail — don't block if lookup fails
    console.warn("IP lookup failed", err);
  }
}

/* Call IP lookup on load */
fetchClientIP();

/* Hotspot behavior: show login box */
document.getElementById('hotspot').addEventListener('click', () => {
  const pwBox = document.getElementById('passwordBox');
  const loginBox = document.getElementById('loginBox');
  // show modern loginBox by default, but also keep legacy passwordBox available
  loginBox.style.display = 'block';
  loginBox.setAttribute('aria-hidden', 'false');
  document.getElementById('loginUser').focus();
});

/* Legacy password check - preserves your previous functionality */
document.getElementById('passwordSubmit').addEventListener('click', () => {
  const pw = document.getElementById('password').value.trim();
  const now = new Date();
  const match = validCredentials.find(c => c.password === pw && new Date(c.expires) > now);
  if (match) {
    document.getElementById('embedContainer').style.display = 'block';
    document.getElementById('passwordBox').style.display = 'none';
  } else {
    alert("❌ Invalid License");
    // optionally log this failed attempt too (use same logger)
    logFailedAttempt({ username: "(legacy-password-only)", reason: "invalid_legacy_password", supplied: pw });
  }
});

/* Login submit (username+password + expiration) */
document.getElementById('loginSubmit').addEventListener('click', async () => {
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value;
  const now = new Date();

  if (!user || !pass) {
    showLoginMsg("Please provide username and password.");
    return;
  }

  const match = validCredentials.find(c => c.username === user && c.password === pass && new Date(c.expires) > now);

  if (match) {
    // success: show embed, hide login
    document.getElementById('embedContainer').style.display = 'block';
    document.getElementById('loginBox').style.display = 'none';
    showLoginMsg("Signed in", false);
  } else {
    // failed — show message and log to Apps Script
    showLoginMsg("Invalid username or password.");
    await logFailedAttempt({
      username: user,
      reason: "invalid_credentials",
      supplied: "(redacted)",
    });
  }
});

/* Function to POST failed attempts to Google Apps Script webhook (if configured) */
async function logFailedAttempt(payload) {
  try {
    const body = {
      timestamp: new Date().toISOString(),
      ip: clientIP || "unknown",
      clientInfo: clientLookupData || null,
      path: location.pathname,
      ua: navigator.userAgent,
      ...payload
    };
    if (!FAILED_LOGIN_WEBHOOK || FAILED_LOGIN_WEBHOOK.startsWith("CHANGE_THIS")) {
      console.warn("FAILED_LOGIN_WEBHOOK not set — skipping log", body);
      return;
    }
    await fetch(FAILED_LOGIN_WEBHOOK, {
      method: "POST",
      mode: "cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });
  } catch (err) {
    console.warn("Failed logging attempt:", err);
  }
}

/* Optional: hide login box if user clicks outside it */
document.addEventListener('click', (e) => {
  const loginBox = document.getElementById('loginBox');
  const hotspot = document.getElementById('hotspot');
  if (!loginBox.contains(e.target) && e.target !== hotspot) {
    // don't hide if embed is visible (let user continue)
    if (document.getElementById('embedContainer').style.display !== 'block') {
      loginBox.style.display = 'none';
      loginBox.setAttribute('aria-hidden', 'true');
      document.getElementById('loginMsg').style.display = 'none';
    }
  }
});
</script>

</body>
</html>
